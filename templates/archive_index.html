{% extends "layout.html" %}

{% block title %}Daily {{ category_display_name }} Archive{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <p class="eyebrow">Archive</p>
        <h1>{{ category_display_name }} 뉴스 아카이브</h1>
        <p class="subtitle">AI/XR 읽을거리의 생성 이력을 날짜별로 살펴보고, 원하는 날의 뉴스를 바로 확인하세요.</p>
    </div>
</div>

{% if run_entries %}
<section class="today-section card">
    <div class="section-heading">
        <div>
            <p class="eyebrow">오늘 뉴스</p>
            <h2 id="selected-date-label"></h2>
            <p class="subtitle" id="selected-time-label"></p>
        </div>
        <div class="pill" id="selected-count"></div>
    </div>
    <div id="today-news-grid" class="news-grid today-grid">
        <p class="empty-msg">뉴스를 불러오는 중입니다...</p>
    </div>
</section>

<section class="calendar-section card">
    <div class="section-heading">
        <div>
            <p class="eyebrow">날짜별 아카이브</p>
            <h3>캘린더에서 날짜를 선택하세요</h3>
            <p class="subtitle">날짜 또는 번호를 누르면 상단의 뉴스 리스트가 해당 회차로 변경됩니다.</p>
        </div>
    </div>
    <div id="calendar-container" class="calendar-container"></div>
</section>

<script>
    const runEntries = {{ run_entries | tojson | safe }};
    const runsByDate = {};
    const todayGrid = document.getElementById('today-news-grid');
    const dateLabel = document.getElementById('selected-date-label');
    const timeLabel = document.getElementById('selected-time-label');
    const countLabel = document.getElementById('selected-count');
    const calendarContainer = document.getElementById('calendar-container');

    function buildRunMap() {
        runEntries.forEach((run, idx) => {
            const list = runsByDate[run.date_str] || [];
            list.push({ ...run, display_index: list.length + 1, absolute_index: idx });
            runsByDate[run.date_str] = list;
        });

        Object.values(runsByDate).forEach(list => {
            list.sort((a, b) => (a.time_str < b.time_str ? 1 : -1));
        });
    }

    function formatDateLabel(dateStr) {
        const parts = dateStr.split('-');
        if (parts.length !== 3) return dateStr;
        return `${parts[0]}년 ${Number(parts[1])}월 ${Number(parts[2])}일`;
    }

    function renderTodayNews(articles, run) {
        todayGrid.innerHTML = '';

        if (!articles.length) {
            todayGrid.innerHTML = '<p class="empty-msg">이 날짜에는 뉴스가 없습니다.</p>';
            return;
        }

        dateLabel.textContent = `${formatDateLabel(run.date_str)} (${run.day_of_week})`;
        timeLabel.textContent = `${run.time_str} 생성됨`;
        countLabel.textContent = `${run.display_index}회차 · ${articles.length}개 기사`;

        articles.forEach(article => {
            const card = document.createElement('article');
            card.className = 'news-card';

            const meta = document.createElement('div');
            meta.className = 'news-card-meta';
            const metaParts = [];
            if (article.source) metaParts.push(article.source);
            if (article.published) metaParts.push(article.published);
            meta.textContent = metaParts.join(' · ');

            const title = document.createElement('h3');
            title.className = 'news-card-title';
            const link = document.createElement('a');
            link.href = article.link;
            link.target = '_blank';
            link.textContent = article.title;
            title.appendChild(link);

            const summary = document.createElement('div');
            summary.className = 'news-card-summary';
            summary.innerHTML = article.summary;

            card.appendChild(title);
            card.appendChild(meta);
            if (article.image) {
                const thumb = document.createElement('div');
                thumb.className = 'news-card-thumb';
                const img = document.createElement('img');
                img.src = article.image;
                img.alt = 'thumbnail';
                img.loading = 'lazy';
                thumb.appendChild(img);
                card.appendChild(thumb);
            }
            card.appendChild(summary);

            todayGrid.appendChild(card);
        });
    }

    async function loadRun(dateStr, runIndex = 0) {
        const runList = runsByDate[dateStr];
        if (!runList || !runList[runIndex]) return;

        const run = runList[runIndex];
        todayGrid.innerHTML = '<p class="empty-msg">뉴스를 불러오는 중입니다...</p>';

        try {
            const response = await fetch(`daily/${run.filename}`);
            const html = await response.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const articles = Array.from(doc.querySelectorAll('.news-item')).map(item => ({
                title: item.querySelector('.news-title a')?.textContent?.trim() || '제목 없음',
                link: item.querySelector('.news-title a')?.getAttribute('href') || '#',
                summary: item.querySelector('.news-summary')?.innerHTML || '',
                source: item.querySelector('.news-meta .source-link')?.textContent?.trim() || '',
                published: item.querySelector('.news-meta')?.textContent?.split('|')[1]?.trim() || '',
                image: item.querySelector('.news-image img')?.getAttribute('src') || ''
            }));

            renderTodayNews(articles, run);
            highlightActive(dateStr, run.display_index);
        } catch (err) {
            todayGrid.innerHTML = `<p class="empty-msg">뉴스를 불러오지 못했습니다: ${err}</p>`;
        }
    }

    function buildCalendar() {
        const monthGroups = {};
        Object.keys(runsByDate).forEach(dateStr => {
            const dateObj = new Date(dateStr + 'T00:00:00');
            if (isNaN(dateObj)) return;
            const key = `${dateObj.getFullYear()}-${dateObj.getMonth()}`;
            if (!monthGroups[key]) monthGroups[key] = { year: dateObj.getFullYear(), month: dateObj.getMonth(), dates: [] };
            monthGroups[key].dates.push(dateObj);
        });

        const sortedKeys = Object.keys(monthGroups).sort((a, b) => Number(b.split('-')[0]) - Number(a.split('-')[0]) || Number(b.split('-')[1]) - Number(a.split('-')[1]));
        calendarContainer.innerHTML = '';

        sortedKeys.forEach(key => {
            const group = monthGroups[key];
            const firstDay = new Date(group.year, group.month, 1);
            const lastDay = new Date(group.year, group.month + 1, 0);

            const monthBlock = document.createElement('div');
            monthBlock.className = 'month-block';

            const header = document.createElement('div');
            header.className = 'month-header';
            header.textContent = `${group.year}년 ${group.month + 1}월`;
            monthBlock.appendChild(header);

            const weekdayRow = document.createElement('div');
            weekdayRow.className = 'weekday-row';
            ['일', '월', '화', '수', '목', '금', '토'].forEach(d => {
                const wd = document.createElement('div');
                wd.textContent = d;
                weekdayRow.appendChild(wd);
            });
            monthBlock.appendChild(weekdayRow);

            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            for (let i = 0; i < firstDay.getDay(); i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${group.year}-${String(group.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                cell.dataset.date = dateStr;

                const dateLabel = document.createElement('button');
                dateLabel.type = 'button';
                dateLabel.className = 'cell-date';
                dateLabel.textContent = day;
                dateLabel.addEventListener('click', () => loadRun(dateStr, 0));
                cell.appendChild(dateLabel);

                const runs = runsByDate[dateStr];
                if (runs && runs.length) {
                    const badges = document.createElement('div');
                    badges.className = 'run-badges';
                    runs.forEach((run, idx) => {
                        const badge = document.createElement('button');
                        badge.type = 'button';
                        badge.className = 'run-badge';
                        badge.textContent = run.display_index;
                        badge.title = `${run.time_str} 회차 보기`;
                        badge.dataset.date = dateStr;
                        badge.dataset.idx = run.display_index;
                        badge.addEventListener('click', (e) => {
                            e.stopPropagation();
                            loadRun(dateStr, idx);
                        });
                        badges.appendChild(badge);
                    });
                    cell.appendChild(badges);
                    cell.addEventListener('click', () => loadRun(dateStr, 0));
                } else {
                    cell.classList.add('empty');
                }

                grid.appendChild(cell);
            }

            monthBlock.appendChild(grid);
            calendarContainer.appendChild(monthBlock);
        });
    }

    function highlightActive(dateStr, displayIndex) {
        document.querySelectorAll('.calendar-cell').forEach(cell => cell.classList.remove('active'));
        const selector = `.calendar-cell[data-date="${dateStr}"]`;
        const target = document.querySelector(selector);
        if (target) target.classList.add('active');

        document.querySelectorAll('.run-badge').forEach(b => b.classList.remove('active'));
        if (displayIndex) {
            const badge = document.querySelector(`.run-badge[data-date="${dateStr}"][data-idx="${displayIndex}"]`);
            if (badge) badge.classList.add('active');
        }
    }

    buildRunMap();
    buildCalendar();
    const newest = runEntries[0];
    if (newest) {
        loadRun(newest.date_str, 0);
    }
</script>
{% else %}
<div class="empty-msg">아직 발행된 뉴스가 없습니다.</div>
{% endif %}
{% endblock %}